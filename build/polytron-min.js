var util={};util.end=function(a){if(a){return a[a.length-1]}return null};util.isset=function(a){if(a){return true}else{if(a==""){return true}}return false};util.max=function(c,b){var a=Math.max.apply(Math,c);if(b){return c.indexOf(a)}return a};util.min=function(c,b){var a=Math.min.apply(Math,c);if(b){return c.indexOf(a)}return a};util.rand=function(b,a){var c=arguments.length;if(c===0){b=0;a=2147483647}else{if(c===1){throw new Error("Warning: rand() expects exactly 2 parameters, 1 given")}}return Math.floor(Math.random()*(a-b+1))+b};this.util=util;function Polylayer(b,a){this.activations=["relu","log","abs","htan2","tanh","atan","sin","htan","gaus"];this.w=[];this.o=[];this.e=[];this.layers=b;this.layer=a;this.m=b[a].model;this.s=b[a].size;this.validateActivation(b);this.validateRate(b);this.validateXmax(b)}Polylayer.prototype.validateActivation=function(b){if(typeof(b[this.layer].active)==="string"){this.active=[];for(var a=0;a<this.s;a++){if(b[this.layer].active=="auto"){}else{if(b[this.layer].active=="rand"){}else{this.active[a]=b[this.layer].active}}}}else{if(b[this.layer].active.length!=this.s){this.active=[];for(var a=0;a<this.s;a++){if(util.isset(b[this.layer].active[a])){this.active[a]=b[this.layer].active[a]}else{this.active[a]=this.active[a-1]}}}else{this.active=b[this.layer].active}}};Polylayer.prototype.validateRate=function(b){if(typeof(b[this.layer].rate)==="string"){}else{if(typeof(b[this.layer].rate)==="number"){this.rate=[];for(var a=0;a<this.s;a++){this.rate[a]=b[this.layer].rate}}else{if(b[this.layer].rate.length!=this.s){this.rate=[];for(var a=0;a<this.s;a++){if(util.isset(b[this.layer].rate[a])){this.rate[a]=b[this.layer].rate[a]}else{this.rate[a]=this.rate[a-1]}}}else{this.rate=b[this.layer].rate}}}};Polylayer.prototype.validateXmax=function(b){if(typeof(b[this.layer].Xmax)==="undefined"){this.Xmax=[];for(var a=0;a<this.s;a++){this.Xmax[a]=1}}else{if(typeof(b[this.layer].Xmax)==="number"){this.Xmax=[];for(var a=0;a<this.s;a++){this.Xmax[a]=b[this.layer].Xmax}}else{if(b[this.layer].Xmax.length!=this.s){this.rate=[];for(var a=0;a<this.s;a++){if(util.isset(b[this.layer].Xmax[a])){this.Xmax[a]=b[this.layer].Xmax[a]}else{this.Xmax[a]=this.Xmax[a-1]}}}else{this.Xmax=b[this.layer].Xmax}}}};Polylayer.prototype.attribute=function(a){if(!this.active[a]){this.a="none"}else{this.a=this.active[a]}if(!this.rate[a]){this.r=0}else{this.r=this.rate[a]}if(!this.Xmax[a]){this.x=1}else{this.x=this.Xmax[a]}};Polylayer.prototype.prepare=function(b){if(!util.isset(this.e)){this.e=[]}if(!util.isset(this.o)){this.o=[]}if(!util.isset(this.w)){this.w=[]}if(this.e.length>this.s){this.e.length=this.s}if(this.o.length>this.s){this.o.length=this.s}if(this.w.length>b.length){this.w.length=b.length}var a=0;for(var c=0;c<this.s;c++){this.attribute(c);a=b.length;for(var d=0;d<a;d++){if(!util.isset(this.w[d])){this.w[d]=[]}if(!util.isset(this.w[d][c])){this.w[d][c]=this.initw()}if(this.w[d].length>this.s){this.w[d].length=this.s}}if(!util.isset(this.w[b.length])){this.w[b.length]=[]}if(!util.isset(this.w[b.length][c])){this.w[b.length][c]=0}if(this.w[b.length].length>this.s){this.w[b.length].length=this.s}if(!util.isset(this.o[c])){this.o[c]=0}if(!util.isset(this.e[c])){this.e[c]=0}}};Polylayer.prototype.forward=function(b){switch(this.m){case"maxout":var a=b[0];this.o=0;var e=this.layers[this.layers.length-2].size;for(var d=1;d<e;d++){if(b[d]>a){a=b[d];this.o=d}}break;default:var f=0;for(var c=0;c<this.s;c++){this.attribute(c);f=0;for(var d=0;b.length>d;d++){f+=b[d]*this.w[d][c]}f+=this.w[b.length][c];this.o[c]=this.differentiate(f)}break}};Polylayer.prototype.errorSum=function(a,c){switch(this.m){case"maxout":break;case"output":for(var d=0;d<this.s;d++){this.attribute(d);this.e[d]=(c[d]-this.o[d])*this.derivatives(this.o[d])}break;case"hidden":for(var b=0;b<this.s;b++){this.attribute(b);this.e[b]=0;for(d=0;d<a.s;d++){this.e[b]+=a.e[d]*a.w[b][d]}this.e[b]*=this.derivatives(this.o[b])}break;default:break}return true};Polylayer.prototype.update=function(b){if(!b){return}var a=util.max(this.e,true);var e=util.min(this.e,true);if(this.e[e]>0){e=-1}switch(this.m){case"output":case"hidden":var d=0;for(var f=0;f<this.s;f++){this.attribute(f);d=this.r;if(e==f){d=this.r*this.x}if(a==f){d=this.r*this.x}for(var c=0;c<b.s;c++){this.w[c][f]+=(d*this.e[f]*b.o[c])}this.w[b.s][f]+=(d*this.e[f])}break;default:break}};Polylayer.prototype.initw=function(){var a=0;switch(this.a){case"none":break;case"log":case"abs":case"tanh":case"sin":case"atan":case"gaus":case"htan2":case"ramp":case"relu":a=((util.rand()/2147483647)-0.5);break;case"htan":a=Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random());break;default:a=((util.rand()/2147483647)-0.5)}return a};Polylayer.prototype.differentiate=function(d,b){if(!b){b=0}var a=0;switch(this.a){case"none":break;case"log":a=(1/(1+Math.exp(-d)));break;case"abs":a=(0.5*(d/(1+Math.abs(d)))+0.5);break;case"tanh":a=((0.5*Math.tanh(d))+0.5);break;case"htan":var c=Math.exp(2*d);a=(c-1)/(c+1);break;case"sin":a=Math.sin(d);break;case"gaus":a=Math.exp(-Math.pow(d,2));break;case"atan":a=Math.atan(d);break;case"htan2":a=(Math.exp(d)-Math.exp(-d))/(Math.exp(d)+Math.exp(-d));break;case"relu":if(d<0){a=0}else{a=d}break;case"ramp":if(d<0){a=(b*d)}else{a=d}break}return a};Polylayer.prototype.derivatives=function(d,b){if(!b){b=0}var a=0;switch(this.a){case"log":case"abs":case"tanh":a=(d*(1-d));break;case"htan":var c=Math.exp(2*d);a=(1-Math.pow((c-1)/(c+1),2));break;case"sin":a=(Math.cos(d));break;case"gaus":a=(-2*d*d);break;case"atan":a=(1/(Math.pow(d,2)+1));break;case"htan2":a=(1-Math.pow(d,2));break;case"relu":if(d<0){a=0}else{a=1}break;case"ramp":if(d<0){a=b}else{a=1}break}return a};this.Polylayer=Polylayer;function Polytron(g,f,a,e,d,b){if(Object.prototype.toString.call(g[0])==="[object Number]"){var h=[];if(!e){e=[];for(var c in g){if(c==0){e[c]="input"}else{if(c==g.length-1){e[c]="output"}else{e[c]="hidden"}}}}for(var c in g){h[c]={};h[c].size=g[c];h[c].model=e[c];if(typeof(f)==="number"){h[c].rate=f}else{if(typeof(f)==="string"){if(f=="auto"){h[c].rate=f;h[c].maxrate=d;h[c].minrate=b}}else{h[c].rate=f[c]}}if(typeof(a)==="string"){h[c].active=a}else{h[c].active=a[c]}}g=h}this.nl=[];this.layers=g;this.w=[];this.o=[];this.e=[]}Polytron.prototype.forward=function(d){var c=d;if(this.e.length>this.layers.length){this.e.length=this.layers.length}if(this.w.length>this.layers.length){this.w.length=this.layers.length}if(this.o.length>this.layers.length){this.o.length=this.layers.length}var e=0;var a=this.layers.length;var b=0;while(b<a){if(!util.isset(this.nl[b])){this.nl[b]=new Polylayer(this.layers,b)}if(b==0){this.nl[b].o=d}if(b>0){this.nl[b].prepare(c);c=this.nl[b].o;this.nl[b].forward(d);d=this.nl[b].o}b++}var f=util.end(this.nl);return f.o};Polytron.prototype.backward=function(c,e){var d=null;var a=this.layers.length-1;for(var b=a;b>0;b--){if(this.nl[b+1]){d=this.nl[b+1]}else{d=null}this.nl[b].errorSum(d,e)}d=null;for(var b=a;b>0;b--){if(this.nl[b-1]){d=this.nl[b-1]}else{d=null}this.nl[b].update(d)}};Polytron.prototype.mse=function(d,a){if(!a){a=util.end(this.o)}var b=this.layers[this.layers.length-1].size;var c=0;for(i=0;i<b;i++){c+=(d[i]-a[i])*(d[i]-a[i])}c=util.end(this.layers).rate*c;return c};Polytron.prototype.make_target=function(c){var d=[];var b=0;var a=this.layers[this.layers.length-1].size;while(b<a){d[b]=(b===c)?1:0;b++}return d};Polytron.prototype.action=function(b){var a=0;var e=0;var a=b[e];var d=this.layers[this.layers.length-1].size;for(var c=1;c<d;c++){if(b[c]>a){a=b[c];e=c}}return e};Polytron.prototype.toJSON=function(){for(var a in this.nl){this.w[a]=this.nl[a].w;this.o[a]=this.nl[a].o;this.e[a]=this.nl[a].e}this.o[0]=[];var b={};b.w=this.w;b.o=this.o;b.e=this.e;return b};Polytron.prototype.fromJSON=function(c){if(util.isset(c)){if(util.isset(c.w)){this.w=c.w}if(util.isset(c.o)){this.o=c.o}if(util.isset(c.e)){this.e=c.e}var a=this.layers.length;for(var b=0;b<a;b++){if(!util.isset(this.nl[b])){this.nl[b]=new Polylayer(this.layers,b);this.nl[b].w=this.w[b];this.nl[b].o=this.o[b];this.nl[b].e=this.e[b]}else{this.nl[b].w=this.w[b];this.nl[b].o=this.o[b];this.nl[b].e=this.e[b]}}}};Polytron.prototype.toString=function(){return JSON.stringify(this.toJSON())};Polytron.prototype.load=function(a){if(a.length>0){this.fromJSON(JSON.parse(a))}};if(typeof(module)==="undefined"||typeof(module.exports)==="undefined"){window.Polytron=Polytron}else{module.exports.Polytron=Polytron}this.Polytron=Polytron;